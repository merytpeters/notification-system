name: Template Service CI (simple)

on:
  push:
    branches:
      - main
      - template-service-dev
    paths:
      - 'template-service/**'
      - '.github/workflows/template-service.yml'
  pull_request:
    paths:
      - 'template-service/**'

permissions:
  contents: read

jobs:
  black-check:
    name: Black format check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Black
        run: python -m pip install --upgrade pip && pip install black

      - name: Run Black (check)
        run: |
          echo "Running black --check on template-service"
          black --version || true
          black --check template-service

  docker-run:
    name: Build and run Docker (sanity)
    needs: black-check
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      github.repository == 'merytpeters/notification-system'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure TEMPLATE_DATABASE_URL secret is set
        run: |
          if [ -z "${{ secrets.TEMPLATE_DATABASE_URL }}" ]; then
            echo "ERROR: secrets.TEMPLATE_DATABASE_URL is not set for this repository.\nSet it under Settings â†’ Secrets to a valid database URL for the template service (or use a test DB)." >&2
            exit 1
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Start Redis container
        run: docker run -d --name redis-ci -p 6379:6379 redis:7

      - name: Build Template Service image
        uses: docker/build-push-action@v4
        with:
          context: template-service
          file: template-service/Dockerfile
          push: false
          load: true
          tags: template-service:ci

      - name: Run Template Service container and perform health check
        shell: bash
        run: |
          set -euo pipefail
          echo "Starting Template Service container..."
          docker run -d --name template-ci \
            -e TEMPLATE_DATABASE_URL="${{ secrets.TEMPLATE_DATABASE_URL }}" \
            -e REDIS_HOST="host.docker.internal" \
            -e REDIS_PORT="6379" \
            -p 8000:8000 \
            template-service:ci

          echo "Waiting up to 20s for /health..."
          for i in {1..20}; do
            if curl -sS http://localhost:8000/health >/dev/null 2>&1; then
              echo "Health check passed"
              break
            fi
            echo "Attempt $i: service not ready yet"
            sleep 1
          done

          echo "Container logs (last 100 lines):"
          docker logs template-ci --tail 100 || true
          docker stop template-ci
          docker rm template-ci
          docker stop redis-ci
          docker rm redis-ci
