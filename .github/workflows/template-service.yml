name: Template Service CI

on:
  push:
    branches:
      - main
      - template-service-dev
    paths:
      - 'template-service/**'
      - '.github/workflows/template-service.yml'
  pull_request:
    paths:
      - 'template-service/**'

permissions:
  contents: read

jobs:
  black-check:
    name: Black format check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Black
        run: python -m pip install --upgrade pip && pip install black

      - name: Run Black (check)
        run: |
          echo "Running black --check on template-service"
          black --version || true
          black --check template-service

  docker-run:
    name: Build and run Docker with Redis
    needs: black-check
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --save 60 1
          --loglevel warning

    env:
      REDIS_HOST: localhost
      REDIS_PORT: 6379
      REDIS_PASSWORD: ""
      TEMPLATE_DATABASE_URL: ${{ secrets.TEMPLATE_DATABASE_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: template-service
          file: template-service/Dockerfile
          push: false
          load: true
          tags: template-service:ci

      - name: Run container and health check
        shell: bash
        run: |
          set -euo pipefail
          echo "Starting container..."
          docker run -d --name template-ci \
            -e TEMPLATE_DATABASE_URL="${TEMPLATE_DATABASE_URL}" \
            -e REDIS_HOST="${REDIS_HOST}" \
            -e REDIS_PORT="${REDIS_PORT}" \
            -e REDIS_PASSWORD="${REDIS_PASSWORD}" \
            -p 8000:8000 \
            template-service:ci
          echo "Waiting up to 20s for /health..."
          for i in {1..20}; do
            if curl -sS http://localhost:8000/health >/dev/null 2>&1; then
              echo "Health check passed"
              break
            fi
            echo "Attempt $i: service not ready yet"
            sleep 1
          done
          echo "Container logs (last 100 lines):"
          docker logs template-ci --tail 100 || true
          docker stop template-ci
          docker rm template-ci || true

